name: Auto Create & Apply Labels (Backend)

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Create missing labels then apply
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const parts = pr.head.ref.split('/');
            const menu = parts[0];
            const type = parts[1];

            // Backend 메뉴 라벨 + 색상 (색상코드 # 없이 6자리만)
            const menuLabels = {
              planner:    "4373FF",
              travelgram: "09B28B",
              mypage:     "8353E6",
              supporter:  "E69A53",
              auth:       "FF5577",
              ai:         "33C1FF",
              common:     "444444"
            };

            // 작업 타입 라벨
            const typeMap = {
              feat:     { name: "feature",  color: "2EB67D" },
              fix:      { name: "fix",      color: "D64545" },
              refactor: { name: "refactor", color: "A371F7" },
              style:    { name: "style",    color: "6F42C1" },
              docs:     { name: "docs",     color: "0366D6" },
              test:     { name: "test",     color: "FF8800" },
              chore:    { name: "chore",    color: "999999" }
            };

            // 필요한 라벨 목록
            const needed = [];

            if (menuLabels[menu]) {
              needed.push({ name: menu, color: menuLabels[menu] });
            }

            if (typeMap[type]) {
              needed.push(typeMap[type]);
            }

            if (needed.length === 0) return;

            // 현재 레포의 모든 라벨 조회
            const existing = await github.paginate(
              github.rest.issues.listLabelsForRepo,
              { owner: context.repo.owner, repo: context.repo.repo }
            );
            const existingNames = existing.map(l => l.name);

            // 1) 존재하지 않는 라벨 자동 생성
            for (const lb of needed) {
              if (!existingNames.includes(lb.name)) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: lb.name,
                  color: lb.color
                });
              }
            }

            // 2) PR에 라벨 부착
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: needed.map(l => l.name)
            });
