package com.example.demo.planner.plan.service.action;

import java.math.BigDecimal;
import java.util.List;

import org.springframework.stereotype.Component;

import com.example.demo.common.naver.dto.LocalItem;
import com.example.demo.common.tools.NaverInternetSearchTool;
import com.example.demo.planner.plan.dto.entity.PlanPlace;
import com.example.demo.planner.plan.service.create.PlanService;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

/**
 * ğŸ¯ PlanActionExecutor - ì—¬í–‰ ì¼ì • ë³€ê²½ ì‘ì—… ì‹¤í–‰ì
 *
 * Function Callingê³¼ PlanService ì‚¬ì´ì˜ ì¤‘ê°„ ë ˆì´ì–´
 * - Functionì—ì„œ ì „ë‹¬ë°›ì€ ìš”ì²­ì„ PlanServiceë¡œ ìœ„ì„
 * - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìº¡ìŠí™” ë° ì¬ì‚¬ìš©ì„± í–¥ìƒ
 * - í†µì¼ëœ ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹…
 *
 * ì•„í‚¤í…ì²˜:
 * SmartPlanAgent
 *   â†’ LLM (Function Calling)
 *   â†’ PlanFunctionConfig (Function Beans)
 *   â†’ PlanActionExecutor (ì´ í´ë˜ìŠ¤)
 *   â†’ PlanService
 *   â†’ DAO
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class PlanActionExecutor {

    private final PlanService planService;
    private final NaverInternetSearchTool naverSearchTool;

    /**
     * ì¼ì •ì—ì„œ ì¥ì†Œ ì‚­ì œ
     *
     * @param planId ì—¬í–‰ ê³„íš ID
     * @param placeName ì‚­ì œí•  ì¥ì†Œëª… (fuzzy matching ì§€ì›)
     * @return ì‹¤í–‰ ê²°ê³¼ ë©”ì‹œì§€
     */
    public String deletePlace(Long planId, String placeName) {
        log.info("ğŸ—‘ï¸ [Executor] ì¥ì†Œ ì‚­ì œ ì‹¤í–‰: planId={}, placeName={}", planId, placeName);

        try {
            planService.deletePlaceByName(planId, placeName);

            String result = String.format("âœ… '%s' ì¥ì†Œë¥¼ ì¼ì •ì—ì„œ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.", placeName);
            log.info(result);
            return result;

        } catch (IllegalArgumentException e) {
            String error = String.format("âŒ '%s' ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", placeName);
            log.warn(error);
            return error;

        } catch (Exception e) {
            String error = String.format("âŒ ì¥ì†Œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: %s", e.getMessage());
            log.error(error, e);
            return error;
        }
    }

    /**
     * ê°™ì€ ë‚ ì§œ ë‚´ì—ì„œ ë‘ ì¥ì†Œì˜ ìˆœì„œ êµí™˜
     *
     * @param planId ì—¬í–‰ ê³„íš ID
     * @param dayIndex ì¼ì°¨ (1ë¶€í„° ì‹œì‘)
     * @param placeIndex1 ì²« ë²ˆì§¸ ì¥ì†Œ ìˆœì„œ (1ë¶€í„° ì‹œì‘)
     * @param placeIndex2 ë‘ ë²ˆì§¸ ì¥ì†Œ ìˆœì„œ (1ë¶€í„° ì‹œì‘)
     * @return ì‹¤í–‰ ê²°ê³¼ ë©”ì‹œì§€
     */
    public String swapPlaces(Long planId, int dayIndex, int placeIndex1, int placeIndex2) {
        log.info("ğŸ”„ [Executor] ê°™ì€ ë‚  ì¥ì†Œ ìˆœì„œ êµí™˜: planId={}, day={}, place1={}, place2={}",
                planId, dayIndex, placeIndex1, placeIndex2);

        try {
            planService.swapPlaceOrdersInner(planId, dayIndex, placeIndex1, placeIndex2);

            String result = String.format("âœ… %dì¼ì°¨ì˜ %dë²ˆì§¸ì™€ %dë²ˆì§¸ ì¥ì†Œ ìˆœì„œë¥¼ êµí™˜í–ˆìŠµë‹ˆë‹¤.",
                    dayIndex, placeIndex1, placeIndex2);
            log.info(result);
            return result;

        } catch (IllegalArgumentException e) {
            String error = String.format("âŒ êµì²´í•  ì¥ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: %s", e.getMessage());
            log.warn(error);
            return error;

        } catch (Exception e) {
            String error = String.format("âŒ ì¥ì†Œ ìˆœì„œ êµí™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: %s", e.getMessage());
            log.error(error, e);
            return error;
        }
    }

    /**
     * ì„œë¡œ ë‹¤ë¥¸ ë‚ ì§œ ê°„ ì¥ì†Œ êµí™˜
     *
     * @param planId ì—¬í–‰ ê³„íš ID
     * @param dayIndex1 ì²« ë²ˆì§¸ ì¼ì°¨ (1ë¶€í„° ì‹œì‘)
     * @param placeIndex1 ì²« ë²ˆì§¸ ì¥ì†Œ ìˆœì„œ (1ë¶€í„° ì‹œì‘)
     * @param dayIndex2 ë‘ ë²ˆì§¸ ì¼ì°¨ (1ë¶€í„° ì‹œì‘)
     * @param placeIndex2 ë‘ ë²ˆì§¸ ì¥ì†Œ ìˆœì„œ (1ë¶€í„° ì‹œì‘)
     * @return ì‹¤í–‰ ê²°ê³¼ ë©”ì‹œì§€
     */
    public String swapPlacesBetweenDays(
            Long planId,
            int dayIndex1,
            int placeIndex1,
            int dayIndex2,
            int placeIndex2
    ) {
        log.info("ğŸ”„ [Executor] ë‚ ì§œ ê°„ ì¥ì†Œ êµí™˜: planId={}, day1={}[{}], day2={}[{}]",
                planId, dayIndex1, placeIndex1, dayIndex2, placeIndex2);

        try {
            planService.swapPlacesBetweenDays(
                planId,
                dayIndex1,
                placeIndex1,
                dayIndex2,
                placeIndex2
            );

            String result = String.format("âœ… %dì¼ì°¨ì˜ %dë²ˆì§¸ ì¥ì†Œì™€ %dì¼ì°¨ì˜ %dë²ˆì§¸ ì¥ì†Œë¥¼ êµí™˜í–ˆìŠµë‹ˆë‹¤.",
                    dayIndex1, placeIndex1, dayIndex2, placeIndex2);
            log.info(result);
            return result;

        } catch (IllegalArgumentException e) {
            String error = String.format("âŒ êµì²´í•  ì¥ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: %s", e.getMessage());
            log.warn(error);
            return error;

        } catch (Exception e) {
            String error = String.format("âŒ ì¥ì†Œ êµí™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: %s", e.getMessage());
            log.error(error, e);
            return error;
        }
    }

    /**
     * íŠ¹ì • ë‚ ì§œì— ìƒˆë¡œìš´ ì¥ì†Œ ì¶”ê°€ (ë„¤ì´ë²„ ê²€ìƒ‰ ì‚¬ìš©)
     *
     * @param planId ì—¬í–‰ ê³„íš ID
     * @param dayIndex ì¼ì°¨ (1ë¶€í„° ì‹œì‘)
     * @param placeName ì¶”ê°€í•  ì¥ì†Œëª…
     * @param startTime ì‹œì‘ ì‹œê°„ (HH:mm í˜•ì‹, ì˜µì…˜)
     * @return ì‹¤í–‰ ê²°ê³¼ ë©”ì‹œì§€
     */
    public String addPlace(Long planId, int dayIndex, String placeName, String startTime) {
        log.info("â• [Executor] ì¥ì†Œ ì¶”ê°€: planId={}, day={}, placeName={}, startTime={}",
                planId, dayIndex, placeName, startTime);

        try {
            // 1. ë„¤ì´ë²„ì—ì„œ ì¥ì†Œ ê²€ìƒ‰
            List<LocalItem> searchResults = naverSearchTool.getLocalInfo(placeName);
            if (searchResults == null || searchResults.isEmpty()) {
                return String.format("âŒ '%s' ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.", placeName);
            }

            LocalItem place = searchResults.get(0);

            // 2. ì¢Œí‘œ ë³€í™˜
            Double lat = convertNaverY(place.getMapy());
            Double lng = convertNaverX(place.getMapx());

            // 3. í•´ë‹¹ day ì°¾ê¸°
            var days = planService.queryAllDaysOptimized(planId);
            var targetDay = days.stream()
                .filter(d -> d.getDay().getDayIndex() == dayIndex)
                .findFirst()
                .orElseThrow(() -> new IllegalArgumentException(
                    dayIndex + "ì¼ì°¨ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."));

            // 4. ì‹œì‘ ì‹œê°„ ì„¤ì • (ì œê³µë˜ì§€ ì•Šìœ¼ë©´ ë§ˆì§€ë§‰ ì¥ì†Œ ë‹¤ìŒ)
            java.time.OffsetDateTime startAtDt;
            if (startTime != null && !startTime.isEmpty()) {
                java.time.LocalTime time = java.time.LocalTime.parse(startTime);
                startAtDt = targetDay.getDay().getPlanDate()
                    .atTime(time)
                    .atZone(java.time.ZoneId.of("Asia/Seoul"))
                    .toOffsetDateTime();
            } else {
                // ë§ˆì§€ë§‰ ì¥ì†Œì˜ ì¢…ë£Œ ì‹œê°„ + 30ë¶„
                var places = targetDay.getPlaces();
                if (places.isEmpty()) {
                    startAtDt = targetDay.getDay().getPlanDate()
                        .atTime(9, 0)
                        .atZone(java.time.ZoneId.of("Asia/Seoul"))
                        .toOffsetDateTime();
                } else {
                    startAtDt = places.get(places.size() - 1).getEndAt().plusMinutes(30);
                }
            }

            // 5. ì¥ì†Œ ìƒì„±
            PlanPlace newPlace = PlanPlace.builder()
                .dayId(targetDay.getDay().getId())
                .title(place.getCategory())
                .startAt(startAtDt)
                .endAt(startAtDt.plusHours(2)) // ê¸°ë³¸ 2ì‹œê°„
                .placeName(cleanHtmlTags(place.getTitle()))
                .address(place.getRoadAddress())
                .lat(lat)
                .lng(lng)
                .expectedCost(BigDecimal.ZERO)
                .build();

            planService.createPlace(newPlace);

            String result = String.format("âœ… %dì¼ì°¨ì— '%s' ì¥ì†Œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. (%s~)",
                    dayIndex, cleanHtmlTags(place.getTitle()), startAtDt.toLocalTime());
            log.info(result);
            return result;

        } catch (Exception e) {
            String error = String.format("âŒ ì¥ì†Œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: %s", e.getMessage());
            log.error(error, e);
            return error;
        }
    }

    /**
     * íŠ¹ì • ì¥ì†Œì˜ ì‹œê°„ ë³€ê²½
     *
     * @param planId ì—¬í–‰ ê³„íš ID
     * @param placeName ì¥ì†Œëª…
     * @param newTime ìƒˆ ì‹œì‘ ì‹œê°„ (HH:mm í˜•ì‹)
     * @return ì‹¤í–‰ ê²°ê³¼ ë©”ì‹œì§€
     */
    public String updatePlaceTime(Long planId, String placeName, String newTime) {
        log.info("â° [Executor] ì¥ì†Œ ì‹œê°„ ë³€ê²½: planId={}, placeName={}, newTime={}",
                planId, placeName, newTime);

        try {
            // 1. ì¥ì†Œ ì°¾ê¸°
            var position = planService.findPlacePosition(placeName, planId);
            if (position == null) {
                return String.format("âŒ '%s' ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", placeName);
            }

            List<PlanPlace> places = planService.queryPlacesByDayId(position.getDayId());
            PlanPlace targetPlace = places.get(position.getOrder() - 1);

            // 2. ì‹œê°„ ë³€ê²½
            java.time.LocalTime time = java.time.LocalTime.parse(newTime);
            planService.updatePlaceTime(targetPlace.getId(), time, null);

            String result = String.format("âœ… '%s'ì˜ ì‹œê°„ì„ %s(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.",
                    placeName, newTime);
            log.info(result);
            return result;

        } catch (Exception e) {
            String error = String.format("âŒ ì‹œê°„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: %s", e.getMessage());
            log.error(error, e);
            return error;
        }
    }

    /**
     * íŠ¹ì • ë‚ ì§œ ì „ì²´ ì‚­ì œ
     *
     * @param planId ì—¬í–‰ ê³„íš ID
     * @param dayIndex ì‚­ì œí•  ì¼ì°¨ (1ë¶€í„° ì‹œì‘)
     * @return ì‹¤í–‰ ê²°ê³¼ ë©”ì‹œì§€
     */
    public String deleteDay(Long planId, int dayIndex) {
        log.info("ğŸ—‘ï¸ [Executor] ë‚ ì§œ ì‚­ì œ: planId={}, dayIndex={}", planId, dayIndex);

        try {
            planService.deleteDay(planId, dayIndex);

            String result = String.format("âœ… %dì¼ì°¨ ì¼ì •ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.", dayIndex);
            log.info(result);
            return result;

        } catch (Exception e) {
            String error = String.format("âŒ ë‚ ì§œ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: %s", e.getMessage());
            log.error(error, e);
            return error;
        }
    }

    /**
     * ë‘ ë‚ ì§œì˜ ì¼ì • ì „ì²´ êµí™˜
     *
     * @param planId ì—¬í–‰ ê³„íš ID
     * @param dayIndex1 ì²« ë²ˆì§¸ ì¼ì°¨
     * @param dayIndex2 ë‘ ë²ˆì§¸ ì¼ì°¨
     * @return ì‹¤í–‰ ê²°ê³¼ ë©”ì‹œì§€
     */
    public String swapDays(Long planId, int dayIndex1, int dayIndex2) {
        log.info("ğŸ”„ [Executor] ë‚ ì§œ êµí™˜: planId={}, day1={}, day2={}",
                planId, dayIndex1, dayIndex2);

        try {
            planService.swapDaySchedules(planId, dayIndex1, dayIndex2);

            String result = String.format("âœ… %dì¼ì°¨ì™€ %dì¼ì°¨ ì¼ì •ì„ êµí™˜í–ˆìŠµë‹ˆë‹¤.",
                    dayIndex1, dayIndex2);
            log.info(result);
            return result;

        } catch (Exception e) {
            String error = String.format("âŒ ë‚ ì§œ êµí™˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: %s", e.getMessage());
            log.error(error, e);
            return error;
        }
    }

    /**
     * ê¸°ì¡´ ì¥ì†Œë¥¼ ìƒˆë¡œìš´ ì¥ì†Œë¡œ êµì²´ (ë„¤ì´ë²„ ê²€ìƒ‰ ì‚¬ìš©)
     *
     * ì¤‘ìš”: ì‚­ì œ+ì¶”ê°€ê°€ ì•„ë‹ˆë¼ UPDATE ë°©ì‹!
     * â†’ ìˆœì„œ, ì‹œê°„, dayId ëª¨ë‘ ìœ ì§€
     * â†’ ì¥ì†Œ ì •ë³´(ì´ë¦„, ì£¼ì†Œ, ì¢Œí‘œ)ë§Œ ë³€ê²½
     *
     * @param planId ì—¬í–‰ ê³„íš ID
     * @param oldPlaceName ê¸°ì¡´ ì¥ì†Œëª…
     * @param newPlaceName ìƒˆ ì¥ì†Œëª…
     * @return ì‹¤í–‰ ê²°ê³¼ ë©”ì‹œì§€
     */
    public String replacePlace(Long planId, String oldPlaceName, String newPlaceName) {
        log.info("ğŸ”„ [Executor] ì¥ì†Œ êµì²´: planId={}, {} â†’ {}",
                planId, oldPlaceName, newPlaceName);

        try {
            // 1. Fuzzy matchingìœ¼ë¡œ ê¸°ì¡´ ì¥ì†Œ ì°¾ê¸°
            var position = planService.findPlacePosition(oldPlaceName, planId);
            if (position == null) {
                return String.format("âŒ '%s' ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", oldPlaceName);
            }

            // 2. dayIdë¡œ ì‹¤ì œ PlanPlace ì¡°íšŒ
            List<PlanPlace> places = planService.queryPlacesByDayId(position.getDayId());
            PlanPlace targetPlace = places.get(position.getOrder() - 1);

            // 3. ë„¤ì´ë²„ì—ì„œ ìƒˆ ì¥ì†Œ ê²€ìƒ‰
            List<LocalItem> searchResults = naverSearchTool.getLocalInfo(newPlaceName);
            if (searchResults == null || searchResults.isEmpty()) {
                return String.format("âŒ '%s' ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.", newPlaceName);
            }

            LocalItem newPlace = searchResults.get(0);

            // 4. ì¢Œí‘œ ë³€í™˜ (ë„¤ì´ë²„ ì¢Œí‘œ â†’ WGS84)
            Double newLat = convertNaverY(newPlace.getMapy());
            Double newLng = convertNaverX(newPlace.getMapx());

            // 5. ì¥ì†Œ ì •ë³´ ì—…ë°ì´íŠ¸ (ìˆœì„œ/ì‹œê°„ ìœ ì§€!)
            planService.replacePlaceWithNew(
                targetPlace.getId(),
                cleanHtmlTags(newPlace.getTitle()),
                newPlace.getRoadAddress(),
                newLat,
                newLng,
                newPlace.getCategory(),
                BigDecimal.ZERO
            );

            String result = String.format("âœ… '%s'ë¥¼ '%s'(ìœ¼)ë¡œ ë³€ê²½í–ˆìŠµë‹ˆë‹¤.",
                    oldPlaceName, cleanHtmlTags(newPlace.getTitle()));
            log.info(result);
            return result;

        } catch (Exception e) {
            String error = String.format("âŒ ì¥ì†Œ êµì²´ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: %s", e.getMessage());
            log.error(error, e);
            return error;
        }
    }

    /**
     * ì—¬í–‰ ê¸°ê°„ í™•ì¥ (ë‚ ì§œ ì¶”ê°€)
     *
     * @param planId ì—¬í–‰ ê³„íš ID
     * @param extraDays ì¶”ê°€í•  ë‚ ì§œ ìˆ˜ (ì˜ˆ: 1 = í•˜ë£¨ ì¶”ê°€)
     * @return ì‹¤í–‰ ê²°ê³¼ ë©”ì‹œì§€
     */
    public String extendPlan(Long planId, int extraDays) {
        log.info("ğŸ“† [Executor] ì¼ì • í™•ì¥: planId={}, extraDays={}", planId, extraDays);

        try {
            // í˜„ì¬ ì¼ì • ì •ë³´ ì¡°íšŒ
            var days = planService.queryAllDaysOptimized(planId);
            if (days.isEmpty()) {
                return "âŒ ì—¬í–‰ ê³„íšì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }

            // í˜„ì¬ ë§ˆì§€ë§‰ ë‚ ì§œ ì°¾ê¸°
            int currentMaxDay = days.stream()
                .mapToInt(d -> d.getDay().getDayIndex())
                .max()
                .orElse(0);

            java.time.LocalDate lastDate = days.get(days.size() - 1).getDay().getPlanDate();

            // ìƒˆ ë‚ ì§œë“¤ ì¶”ê°€
            for (int i = 1; i <= extraDays; i++) {
                java.time.LocalDate newDate = lastDate.plusDays(i);
                com.example.demo.planner.plan.dto.entity.PlanDay newDay =
                    com.example.demo.planner.plan.dto.entity.PlanDay.builder()
                    .planId(planId)
                    .dayIndex(currentMaxDay + i)
                    .planDate(newDate)
                    .build();
                planService.createDay(newDay, true);
            }

            String result = String.format("âœ… ì—¬í–‰ì„ %dì¼ ì—°ì¥í–ˆìŠµë‹ˆë‹¤. (ì´ %dì¼ ì—¬í–‰)",
                    extraDays, currentMaxDay + extraDays);
            log.info(result);
            return result;

        } catch (Exception e) {
            String error = String.format("âŒ ì¼ì • í™•ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: %s", e.getMessage());
            log.error(error, e);
            return error;
        }
    }

    /**
     * ë„¤ì´ë²„ X ì¢Œí‘œ(ê²½ë„)ë¥¼ WGS84ë¡œ ë³€í™˜
     */
    private Double convertNaverX(String mapx) {
        if (mapx == null || mapx.isEmpty()) return null;
        return Double.parseDouble(mapx) / 10000000.0;
    }

    /**
     * ë„¤ì´ë²„ Y ì¢Œí‘œ(ìœ„ë„)ë¥¼ WGS84ë¡œ ë³€í™˜
     */
    private Double convertNaverY(String mapy) {
        if (mapy == null || mapy.isEmpty()) return null;
        return Double.parseDouble(mapy) / 10000000.0;
    }

    /**
     * HTML íƒœê·¸ ì œê±°
     */
    private String cleanHtmlTags(String text) {
        if (text == null) return null;
        return text.replaceAll("<[^>]*>", "");
    }
}
