<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.common.chat.dao.ChatMemoryDao">

    <!-- 단기 메모리(chat_memories)에 일반 메시지 저장 -->
    <insert id="insertChatMemory" parameterType="com.example.demo.common.chat.dto.ChatMemory">
        <selectKey keyProperty="id" resultType="long" order="AFTER">
            SELECT currval('chat_memories_id_seq')
        </selectKey>
        INSERT INTO chat_memories (
            user_id,
            agent_name,
            order_index,
            content,
            token_usage,
            created_at,
            role
        ) VALUES (
            #{userId},
            #{agentName},
            #{orderIndex},
            #{content},
            #{tokenUsage},
            now(),
            #{role}
        )
    </insert>

    <!-- 장기 메모리(chat_memory_vectors)에 임베딩 벡터 메시지 저장 -->
    <insert id="insertChatMemoryVector" parameterType="com.example.demo.common.chat.dto.ChatMemoryVector">
        <selectKey keyProperty="id" resultType="long" order="AFTER">
            SELECT currval('chat_memory_vectors_id_seq')
        </selectKey>
        INSERT INTO chat_memory_vectors (
            user_id,
            agent_name,
            order_index,
            content,
            token_usage,
            created_at,
            role,
            embedding
        ) VALUES (
            #{userId},
            #{agentName},
            #{orderIndex},
            #{content},
            #{tokenUsage},
            now(),
            #{role},
            #{embedding}
        )
    </insert>

    <!-- userId 기준 단기 메모리 개수 조회 -->
    <select id="countByConversationId" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM chat_memories
        WHERE user_id = #{userId}
    </select>

    <!-- 벡터 유사도 기반 장기기억 검색 -->
    <select id="getSimilarMessages" parameterType="map"
            resultType="com.example.demo.common.chat.dto.ChatMemoryVector">
        <![CDATA[
        SELECT *
        FROM chat_memory_vectors
        WHERE user_id = #{userId}
        ORDER BY embedding <-> #{queryEmbedding}
        LIMIT #{topK}
        ]]>
    </select>

    <!-- 최근 N개 단기 메모리 조회 (Short-term) -->
    <select id="findRecentMessages" resultType="com.example.demo.common.chat.dto.ChatMemory">
        SELECT *
        FROM chat_memories
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 단기 메모리: id(PK) 기준 삭제 -->
    <delete id="deleteChatMemoryById" parameterType="long">
        DELETE
        FROM chat_memories
        WHERE id = #{id}
    </delete>

    <!-- 장기 메모리: userId 기준 전체 삭제 (필요 시) -->
    <delete id="deleteVectorByUserId" parameterType="long">
        DELETE
        FROM chat_memory_vectors
        WHERE user_id = #{userId}
    </delete>

    <!-- 해당 user의 가장 오래된 단기 메모리 1개 조회 -->
    <select id="findOldestMessage" parameterType="long"
            resultType="com.example.demo.common.chat.dto.ChatMemory">
        SELECT *
        FROM chat_memories
        WHERE user_id = #{userId}
        ORDER BY created_at ASC
        LIMIT 1
    </select>

    <!-- 해당 user의 마지막 order_index (가장 큰 값) -->
    <select id="findMaxOrderIndex" parameterType="long" resultType="java.lang.Integer">
        SELECT MAX(order_index)
        FROM chat_memories
        WHERE user_id = #{userId}
    </select>

</mapper>
