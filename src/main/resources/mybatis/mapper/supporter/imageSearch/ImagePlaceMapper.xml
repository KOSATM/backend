<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.supporter.imageSearch.dao.ImagePlaceDao">
  <resultMap id="ImagePlaceResultMap" type="ImagePlace">
    <id column="id"                  property="id"/>
    <result column="name"            property="name"/>
    <result column="description"     property="description"/>
    <result column="lat"             property="lat"/>
    <result column="lng"             property="lng"/>
    <result column="address"         property="address"/>
    <result column="place_type"      property="placeType"/>
    <result column="internal_original_url"  property="internalOriginalUrl"/>
    <result column="internal_thumbnail_url" property="internalThumbnailUrl"/>
    <result column="external_image_url"     property="externalImageUrl"/>
    <result column="image_status"           property="imageStatus"/>
  </resultMap>

  <insert id="save" parameterType="ImagePlaceResponse" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO image_places (
      name, content, lat, lng, address, place_type,
      internal_original_url, internal_thumbnail_url,
      external_image_url, image_status
    ) VALUES (
      #{name}, #{description}, #{lat}, #{lng}, #{address}, #{placeType},
      #{internalOriginalUrl}, #{internalThumbnailUrl},
      #{externalImageUrl}, CAST(#{imageStatus, jdbcType=VARCHAR} AS image_status_enum)
    )
  </insert>

  <!-- 단건 조회 -->
  <select id="selectById" parameterType="long" resultMap="ImagePlaceResultMap">
    SELECT id,name,description,lat,lng,address,place_type,
           internal_original_url,internal_thumbnail_url,
           external_image_url,image_status
    FROM image_places
    WHERE id = #{id}
  </select>

  <!-- place_type 기준 조회 -->
  <select id="selectByPlaceType" parameterType="string" resultMap="ImagePlaceResultMap">
    SELECT id,name,description,lat,lng,address,place_type,
           internal_original_url,internal_thumbnail_url,
           external_image_url,image_status
    FROM image_places
    WHERE place_type = #{placeType}
    ORDER BY name ASC
  </select>

  <!-- 전체 조회 -->
  <select id="selectAll" resultMap="ImagePlaceResultMap">
    SELECT id,name,description,lat,lng,address,place_type,
           internal_original_url,internal_thumbnail_url,
           external_image_url,image_status
    FROM image_places
    ORDER BY id DESC
  </select>

  <!-- 위경도 범위 조회 -->
  <select id="selectByLatLngBounds" parameterType="map" resultMap="ImagePlaceResultMap">
    SELECT id,name,description,lat,lng,address,place_type,
           internal_original_url,internal_thumbnail_url,
           external_image_url,image_status
    FROM image_places
    WHERE lat BETWEEN #{minLat} AND #{maxLat}
      AND lng BETWEEN #{minLng} AND #{maxLng}
    ORDER BY name ASC
  </select>

  <!-- INSERT -->
  <insert id="insert" parameterType="ImagePlace" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO image_places (
      name, description, lat, lng, address, place_type,
      internal_original_url, internal_thumbnail_url,
      external_image_url, image_status
    ) VALUES (
      #{name}, #{description}, #{lat}, #{lng}, #{address}, #{placeType},
      #{internalOriginalUrl}, #{internalThumbnailUrl},
      #{externalImageUrl}, #{imageStatus}
    )
  </insert>

  <!-- 배치 INSERT -->
  <insert id="batchInsert" parameterType="list">
    INSERT INTO image_places (
      name, description, lat, lng, address, place_type,
      internal_original_url, internal_thumbnail_url,
      external_image_url, image_status
    ) VALUES
    <foreach collection="list" item="p" separator=",">
      (#{p.name}, #{p.description}, #{p.lat}, #{p.lng}, #{p.address}, #{p.placeType},
       #{p.internalOriginalUrl}, #{p.internalThumbnailUrl},
       #{p.externalImageUrl}, #{p.imageStatus})
    </foreach>
  </insert>

  <!-- UPDATE -->
  <update id="update" parameterType="ImagePlace">
    UPDATE image_places
    SET name = #{name},
        description = #{description},
        lat = #{lat},
        lng = #{lng},
        address = #{address},
        place_type = #{placeType},
        internal_original_url = #{internalOriginalUrl},
        internal_thumbnail_url = #{internalThumbnailUrl},
        external_image_url = #{externalImageUrl},
        image_status = #{imageStatus}
    WHERE id = #{id}
  </update>

  <!-- DELETE (단건) -->
  <delete id="deleteById" parameterType="long">
    DELETE FROM image_places WHERE id = #{id}
  </delete>

  <!-- place_type 기준 삭제 -->
  <delete id="deleteByPlaceType" parameterType="string">
    DELETE FROM image_places WHERE place_type = #{placeType}
  </delete>

  <!-- FIND BY NAME AND ADDRESS -->
  <select id="findByNameAndAddress" resultMap="ImagePlaceResultMap">
    SELECT * FROM image_places
    WHERE name = #{name} AND address = #{address}
    LIMIT 1
  </select>
</mapper>
