<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.planner.hotel.dao.HotelCandidateDao">

    <resultMap id="HotelRatePlanCandidateMap" type="com.example.demo.planner.hotel.dto.entity.HotelRatePlanCandidate">
        <result column="hotel_id" property="hotelId" />
        <result column="room_type_id" property="roomTypeId" />
        <result column="rate_plan_id" property="ratePlanId" />
        <result column="hotel_name" property="hotelName" />
        <result column="district" property="district" />
        <result column="neighborhood" property="neighborhood" />
        <result column="address_line1" property="addressLine1" />
        <result column="latitude" property="latitude" />
        <result column="longitude" property="longitude" />
        <result column="star_rating" property="starRating" />
        <result column="rating_score" property="ratingScore" />
        <result column="review_count" property="reviewCount" />
        <result column="total_price" property="totalPrice" />
        <result column="tax_amount" property="taxAmount" />
        <result column="fee_amount" property="feeAmount" />
        <result column="currency" property="currency" />
    </resultMap>

    <select id="findCandidates" resultMap="HotelRatePlanCandidateMap">
        SELECT DISTINCT
            h.id as hotel_id,
            h.name as hotel_name,
            h.district,
            h.neighborhood,
            h.address_line1,
            h.latitude,
            h.longitude,
            h.star_rating,
            h.rating_score,
            h.review_count,
            h.has_free_wifi,
            h.has_parking,
            h.is_pet_friendly,
            h.is_family_friendly,
            h.has_24h_frontdesk,
            h.has_english_staff,
            h.near_metro,
            h.metro_station_name,
            h.airport_distance_km,
            h.has_breakfast_restaurant,
            r.id as room_type_id,
            r.name as room_type_name,
            r.bed_type,
            r.room_size_sqm,
            r.has_kitchenette,
            r.is_accessible_room,
            p.id as rate_plan_id,
            p.name as rate_plan_name,
            p.meal_plan,
            p.includes_breakfast,
            SUM(pr.price) as total_price,
            SUM(pr.tax_amount) as tax_amount,
            SUM(pr.fee_amount) as fee_amount,
            p.currency
        FROM hotels h
        INNER JOIN hotel_rooms r ON h.id = r.hotel_id
        INNER JOIN hotel_rate_plans p ON r.id = p.room_type_id
        INNER JOIN hotel_rate_plan_prices pr ON p.id = pr.rate_plan_id
        WHERE h.is_active = true
          AND r.max_occupancy >= (#{adults} + #{children})
          AND pr.is_closed = false
          AND pr.stay_date >= #{checkinDate}
          AND pr.stay_date &lt;= #{checkoutDate}
        GROUP BY h.id, h.name, h.district, h.neighborhood, h.address_line1, h.latitude, h.longitude, 
                 h.star_rating, h.rating_score, h.review_count, h.has_free_wifi, h.has_parking, 
                 h.is_pet_friendly, h.is_family_friendly, h.has_24h_frontdesk, h.has_english_staff,
                 h.near_metro, h.metro_station_name, h.airport_distance_km, h.has_breakfast_restaurant,
                 r.id, r.name, r.bed_type, r.room_size_sqm, r.has_kitchenette, r.is_accessible_room,
                 p.id, p.name, p.meal_plan, p.includes_breakfast, p.currency
        ORDER BY total_price ASC, h.rating_score DESC
        LIMIT 20
    </select>

</mapper>
