<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.planner.plan.dao.PlanPlaceDao">

    <!-- ==================== 조회(READ) 기능 ==================== -->

    <!-- 단일 장소 조회: ID로 특정 여행 장소 하나를 조회 -->
    <select id="selectPlanPlaceById" parameterType="long" resultType="PlanPlace"> SELECT id, day_id,
        title, start_at, end_at, place_name, address, lat, lng, expected_cost FROM plan_places WHERE
        id = #{id} </select>

    <!-- 특정 일자의 모든 장소 조회: 한 날짜(PlanDay)에 속한 모든 장소를 시간순으로 조회 -->
    <select id="selectPlanPlacesByPlanDayId" parameterType="long" resultType="PlanPlace"> SELECT id,
        day_id, title, start_at, end_at, place_name, address, lat, lng, expected_cost FROM
        plan_places WHERE day_id = #{dayId} ORDER BY start_at ASC </select>

    <!-- 여행 계획의 모든 장소 조회: 전체 여행(Plan)의 모든 장소를 일자순, 시간순으로 조회 -->
    <select id="selectPlanPlacesByPlanId" parameterType="long" resultType="PlanPlace"> SELECT
        tplace.id, tplace.day_id, tplace.title, tplace.start_at, tplace.end_at, tplace.place_name,
        tplace.address, tplace.lat, tplace.lng, tplace.expected_cost FROM plan_places tplace INNER
        JOIN plan_days td ON tplace.day_id = td.id WHERE td.plan_id = #{planId} ORDER BY
        td.day_index ASC, tplace.start_at ASC </select>

    <!-- ==================== 생성(CREATE) 기능 ==================== -->

    <!-- 장소 단건 생성: 새로운 여행 장소 하나를 추가 -->
    <insert id="insertPlanPlace" parameterType="PlanPlace" useGeneratedKeys="true" keyProperty="id"
        keyColumn="id"> INSERT INTO plan_places (day_id, title, start_at, end_at, place_name,
        address, lat, lng, expected_cost) VALUES (#{dayId}, #{title}, #{startAt}, #{endAt},
        #{placeName}, #{address}, #{lat}, #{lng}, #{expectedCost}) </insert>

    <!-- 장소 일괄 생성: 여러 장소를 한번에 추가 (배치 insert) -->
    <insert id="insertPlanPlaceBatch"> INSERT INTO plan_places ( day_id, title, start_at, end_at,
        place_name, address, lat, lng, expected_cost ) VALUES <foreach collection="list"
            item="place" separator=","> ( #{place.dayId}, #{place.title}, #{place.startAt},
        #{place.endAt}, #{place.placeName}, #{place.address}, #{place.lat}, #{place.lng},
        #{place.expectedCost} ) </foreach>
    </insert>

    <!-- ==================== 수정(UPDATE) 기능 ==================== -->

    <!-- 장소 전체 수정: 장소의 모든 정보를 업데이트 (시간 교환, 전체 변경 시 사용) -->
    <update id="updatePlanPlace" parameterType="PlanPlace"> UPDATE plan_places SET day_id =
        #{dayId}, title = #{title}, start_at = #{startAt}, end_at = #{endAt}, place_name =
        #{placeName}, address = #{address}, lat = #{lat}, lng = #{lng}, expected_cost =
        #{expectedCost} WHERE id = #{id} </update>

    <!-- 장소의 일자 변경: 장소를 다른 날짜로 이동 (날짜 간 장소 교환 시 사용) -->
    <update id="updatePlanDayId"> UPDATE plan_places SET day_id = #{planDayId} WHERE id = #{id} </update>

    <!-- 장소 정보 수정: 장소명, 주소, 좌표, 카테고리, 비용만 업데이트 (장소 교체 시 사용) -->
    <update id="updatePlaceInfo"> UPDATE plan_places SET place_name = #{placeName}, address =
        #{address}, lat = #{latitude}, lng = #{longitude}, title = #{category}, expected_cost =
        #{cost} WHERE id = #{id} </update>

    <!-- 장소 시작 시간 변경: 방문 시작 시간만 수정 -->
    <update id="updatePlaceTime"> UPDATE plan_places SET start_at = #{time} WHERE id = #{id} </update>

    <!-- 장소 소요시간 변경: 시작 시간에서 duration 분만큼 더한 종료 시간으로 설정 -->
    <update id="updatePlaceDuration"> UPDATE plan_places SET end_at = start_at + (#{duration} || '
        minutes')::interval WHERE id = #{id} </update>

    <!-- ==================== 삭제(DELETE) 기능 ==================== -->

    <!-- 장소 단건 삭제: ID로 특정 장소 하나만 삭제 -->
    <delete id="deletePlanPlace" parameterType="long"> DELETE FROM plan_places WHERE id = #{id} </delete>

    <!-- 특정 일자의 모든 장소 삭제: 한 날짜에 속한 모든 장소를 삭제 (일자 삭제 시 사용) -->
    <delete id="deletePlacesByDayId" parameterType="long"> DELETE FROM plan_places WHERE day_id =
        #{dayId} </delete>

    <!-- 장소 삭제 (ID로): deletePlanPlace와 동일, 다른 이름으로 제공 -->
    <delete id="deletePlanPlaceById" parameterType="long"> DELETE FROM plan_places WHERE id = #{id} </delete>

</mapper>
